version: "3.9"

services:
  # 1. PostgreSQL Database Service
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: hellodb
      POSTGRES_USER: hello
      POSTGRES_PASSWORD: hello123
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    # Note: Removed ports mapping for 5432. It's only needed internally.
    
    # ðŸ’¡ ADDED: Health check to ensure DB is accepting connections before Django starts
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hello -d hellodb"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  # 2. Django Web Application Service
  web:
    # ðŸ’¡ CHANGED: Replace 'build: .' with the ECR image reference
    # Docker Compose will pull this image during the 'docker compose pull' step.
    image: 534232118663.dkr.ecr.ap-south-1.amazonaws.com/hellooo:latest # <-- REPLACE with your actual ECR URI
    
    # ðŸ’¡ CHANGED: Use Gunicorn for a near-production deployment and wait for DB health
    command: >
      sh -c "
      python manage.py migrate --noinput &&
      gunicorn helloworld.wsgi:application --bind 0.0.0.0:8000
      "
    # volumes:
    #   - .:/app # Removed volume mapping, as we don't want local code sync in CD

    # ports:
    #   - "8000:8000"
      
    environment:
      # These environment variables must be used in your Django settings.py file
      - DEBUG=1
      - DATABASE_NAME=hellodb
      - DATABASE_USER=hello
      - DATABASE_PASSWORD=hello123
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      # Add ECR repository URL here if needed in Django settings
      # - ECR_REPOSITORY=534232118663.dkr.ecr.ap-south-1.amazonaws.com/mydjango

    # ðŸ’¡ CHANGED: Wait for DB service, and specifically wait until the health check passes
    depends_on:
      db:
        condition: service_healthy

# ðŸ’¡ NEW SERVICE: Nginx Reverse Proxy
  nginx:
    image: nginx:stable-alpine
    restart: always
    ports:
      # Expose port 80 (HTTP) to the host EC2 machine
      - "80:80"
    volumes:
     - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      # ðŸ’¡ NEW: Mount the entrypoint script
     - ./nginx/docker-entrypoint.sh:/docker-entrypoint.sh 
    # ðŸ’¡ NEW: Tell Nginx to use the script as its entrypoint
    entrypoint: ["/bin/sh", "/docker-entrypoint.sh"] 
    depends_on:
    - web
volumes:
  postgres_data:













# ubuntu@ip-172-31-14-78:~$ cd nginx/
# ubuntu@ip-172-31-14-78:~/nginx$ ls
# nginx.conf
# ubuntu@ip-172-31-14-78:~/nginx$ cat nginx.conf
# server {
#     listen 80;
#     server_name _; # Accepts any host header

#     location / {
#         # Proxy traffic to the 'web' service (Django container) on port 8000
#         proxy_pass http://web:8000;

#         # Standard headers for passing host/IP information
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     }
# }
# ubuntu@ip-172-31-14-78:~/nginx$


























# ubuntu@ip-172-31-14-78:~$ ls
# alertmanager  aws  awscliv2.zip  docker-compose.yml  nginx  prometheus
# ubuntu@ip-172-31-14-78:~$ cd alertmanager/
# ubuntu@ip-172-31-14-78:~/alertmanager$ ls
# config.yml
# ubuntu@ip-172-31-14-78:~/alertmanager$ cat config.yml
# # ./alertmanager/config.yml
# global:
#   # The default email address to use in the 'email' receiver
#   smtp_smarthost: 'smtp.example.com:587'
#   smtp_from: 'janyakon31@gmail.com'
#   smtp_auth_username: 'janyakon31@gmail.com'
#   smtp_auth_password: 'QWRpdHlhQDI='

# route:
#   receiver: 'default-receiver'

# receivers:
#   - name: 'default-receiver'
#     # Placeholder for actual notification configuration (e.g., email, Slack, PagerDuty)
#     # For now, it just receives the alert silently.
#     email_configs:
#       - to: 'janyakon31@gmail.com'
























# ubuntu@ip-172-31-14-78:~$ cd prometheus/
# ubuntu@ip-172-31-14-78:~/prometheus$ ls
# prometheus.yml
# ubuntu@ip-172-31-14-78:~/prometheus$ cat prometheus.yml
# # ./prometheus/prometheus.yml
# global:
#   scrape_interval: 15s # How often to scrape targets (default is 1m)
#   evaluation_interval: 15s # Evaluate rules every 15 seconds

# # Alertmanager configuration
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets:
#             - alertmanager:9093 # Connects to the Alertmanager container

# rule_files:
#   - 'alerts.yml' # Placeholder for future alerts

# scrape_configs:
#   # Scrape Prometheus itself
#   - job_name: 'prometheus'
#     static_configs:
#       - targets: ['localhost:9090']

#   # Scrape cAdvisor for container metrics
#   - job_name: 'cadvisor'
#     static_configs:
#       - targets: ['cadvisor:8080']

#   # Scrape your Django/Gunicorn application metrics (if implemented with a Python client like Prometheus Client)
#   - job_name: 'web_app'
#     static_configs:
#       - targets: ['web:8000'] # Assuming your Django app exposes metrics at http://web:8000/metrics
# ubuntu@ip-172-31-14-78:~/prometheus$












































# ubuntu@ip-172-31-14-78:~$ cat docker-compose.yml
# version: "3.9"

# services:
#   db:
#     image: postgres:16-alpine
#     environment:
#       POSTGRES_DB: hellodb
#       POSTGRES_USER: hello
#       POSTGRES_PASSWORD: hello123
#     volumes:
#       - postgres_data:/var/lib/postgresql/data/
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U hello -d hellodb"]
#       interval: 5s
#       timeout: 5s
#       retries: 5
#       start_period: 10s
#   web:
#     image: 534232118663.dkr.ecr.ap-south-1.amazonaws.com/helloworld-monitor-ecr:latest # <-- REPLACE with your actual ECR URI
#     command: >
#       sh -c "
#       python manage.py migrate --noinput &&
#       gunicorn helloworld.wsgi:application --bind 0.0.0.0:8000
#       "
#     environment:
#       - DEBUG=1
#       - DATABASE_NAME=hellodb
#       - DATABASE_USER=hello
#       - DATABASE_PASSWORD=hello123
#       - DATABASE_HOST=db
#       - DATABASE_PORT=5432
#     depends_on:
#       db:
#         condition: service_healthy
#   nginx:
#     image: nginx:stable-alpine
#     restart: always
#     ports:
#       - "80:80"
#     volumes:
#      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
#     depends_on:
#     - web

#   cadvisor:
#     image: gcr.io/cadvisor/cadvisor:latest
#     container_name: cadvisor
#     privileged: true
#     restart: always
#     ports:
#       - "8080:8080"
#     volumes:
#       - /:/rootfs:ro
#       - /var/run:/var/run:rw
#       - /sys:/sys:ro
#       - /var/lib/docker/:/var/lib/docker:ro
#       - /dev/disk/:/dev/disk:ro

#   prometheus:
#     image: prom/prometheus:latest
#     container_name: prometheus
#     restart: always
#     ports:
#       - "9090:9090"
#     volumes:
#       - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
#       - prometheus_data:/prometheus
#     command:
#       - '--config.file=/etc/prometheus/prometheus.yml'
#       - '--storage.tsdb.path=/prometheus'
#       - '--web.console.libraries=/usr/share/prometheus/console_libraries'
#       - '--web.console.templates=/usr/share/prometheus/consoles'
#     depends_on:
#       - cadvisor
#       - web # Assuming you'll expose a metrics endpoint in Django/Gunicorn
#       - alertmanager
#   alertmanager:
#     image: prom/alertmanager:latest
#     container_name: alertmanager
#     restart: always
#     ports:
#       - "9093:9093"
#     volumes:
#       - ./alertmanager/config.yml:/etc/alertmanager/config.yml:ro
#     command:
#       - '--config.file=/etc/alertmanager/config.yml'
#       - '--storage.path=/alertmanager'

#   # 7. Grafana (Visualization Dashboard)
#   grafana:
#     image: grafana/grafana:latest
#     container_name: grafana
#     restart: always
#     ports:
#       - "3000:3000"
#     volumes:
#       - grafana_data:/var/lib/grafana
#     environment:
#       - GF_SECURITY_ADMIN_USER=admin
#       - GF_SECURITY_ADMIN_PASSWORD=admin # CHANGE THIS!
#     depends_on:
#       - prometheus

# volumes:
#   postgres_data:
#   static_volume:
#   prometheus_data:
#   grafana_data:















# ----------------------------------------------------------------------
# version: "3.9"
# services:
#   db:
#     image: postgres:16-alpine
#     environment:
#       POSTGRES_DB: hellodb
#       POSTGRES_USER: hello
#       POSTGRES_PASSWORD: hello123
#     volumes:
#       - postgres_data:/var/lib/postgresql/data/
#     ports:
#       - "5432:5432"

#   web:
#     build: .
#     command: >
#       sh -c "python manage.py migrate --noinput &&
#              python manage.py runserver 0.0.0.0:8000"
#     volumes:
#       - .:/app
#     ports:
#       - "8000:8000"
      
#     environment:
#       - DEBUG=1
#       - DATABASE_NAME=hellodb
#       - DATABASE_USER=hello
#       - DATABASE_PASSWORD=hello123
#       - DATABASE_HOST=db
#       - DATABASE_PORT=5432
#     depends_on:
#       - db

# volumes:
#   postgres_data:
